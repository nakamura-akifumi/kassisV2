{% extends 'base.html.twig' %}

{% block title %}ファイルエクスポート{% endblock %}

{% block body %}
    <div class="container py-2">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-primary text-white py-1">
                <h2 class="mb-0 fs-5 lh-1">ファイルエクスポート（Excel / CSV）</h2>
            </div>

            <div class="card-body p-3">
                <div class="alert alert-info small">
                    <p class="mb-0">エクスポート形式を選択して「エクスポート」ボタンを押してください。</p>
                    <p class="mb-0 mt-1">（検索条件がURLに付いている場合、その条件でエクスポートします）</p>
                </div>

                {# fetch失敗時の表示領域（textContentのみで埋める） #}
                <div class="alert alert-danger small d-none" id="export-error" role="alert">
                    <div class="fw-bold mb-1" id="export-error-title">エクスポートに失敗しました</div>
                    <ul class="mb-0 ps-3" id="export-error-list"></ul>
                </div>

                {{ form_start(form, {'attr': {'class': 'needs-validation', 'id': 'manifestation-export-form'}}) }}

                {# 検索条件の引き継ぎ（GETパラメータをそのまま hidden で維持） #}
                {% for key, value in query %}
                    {% if value is not empty %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                {% endfor %}

                <div class="mb-3">
                    {{ form_label(form.format, null, {'label_attr': {'class': 'form-label small mb-2 fw-bold'}}) }}
                    {{ form_widget(form.format) }}
                    <div class="form-text text-danger small">
                        {{ form_errors(form.format) }}
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">1. 出力項目を選択してください</label>
                    <div class="row g-2">
                        {% set fields = [
                            'Id', 'Title', 'Title_Transcription', 'Identifier', 'External_identifier1',
                            'External_identifier2', 'External_identifier3', 'Description', 'Buyer',
                            'Buyer_identifier', 'Purchase_date', 'RecordSource', 'Type1', 'Type2',
                            'Type3', 'Type4', 'Class1', 'Class2', 'Location1', 'Location2', 'Contributor1', 'Contributor2',
                            'Status1', 'Status2', 'ReleaseDateString', 'Price', 'CreatedAt', 'UpdatedAt'
                        ] %}
                        {% for field in fields %}
                            {% set fieldKey = field|first|lower ~ field|slice(1) %}
                            {% set isRequired = fieldKey in ['id', 'title', 'identifier'] %}
                            <div class="col-md-3 col-sm-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="{{ form.columns.vars.full_name }}[]"
                                               value="{{ fieldKey }}" id="col_{{ fieldKey }}"
                                               {% if isRequired %}checked disabled{% else %}checked{% endif %}>
                                    <label class="form-check-label" for="col_{{ fieldKey }}">
                                        {{ ('Model.Manifestation.fields.' ~ field) | trans }}
                                    </label>
                                    {# disabledな要素は送信されないため、必須項目はhiddenで確実に送る #}
                                    {% if isRequired %}
                                        <input type="hidden" name="{{ form.columns.vars.full_name }}[]" value="{{ fieldKey }}">
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                    <button type="submit" class="btn btn-primary btn-sm" id="export-btn">
                        <span id="export-btn-text">エクスポート</span>
                        <span id="export-btn-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                    <a href="{{ path('app_manifestation_index') }}" class="btn btn-outline-secondary btn-sm">
                        一覧に戻る
                    </a>
                </div>

                {{ form_end(form) }}
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('manifestation-export-form');
            const btn = document.getElementById('export-btn');
            const btnText = document.getElementById('export-btn-text');
            const spinner = document.getElementById('export-btn-spinner');

            const errorBox = document.getElementById('export-error');
            const errorTitle = document.getElementById('export-error-title');
            const errorList = document.getElementById('export-error-list');

            if (!form || !btn || !btnText || !spinner || !errorBox || !errorTitle || !errorList) return;

            const originalText = btnText.textContent;

            function setLoading(isLoading) {
                if (isLoading) {
                    btn.disabled = true;
                    btnText.textContent = 'エクスポート処理中...';
                    spinner.classList.remove('d-none');
                    btn.classList.add('btn-secondary');
                    btn.classList.remove('btn-primary');
                } else {
                    btn.disabled = false;
                    btnText.textContent = originalText;
                    spinner.classList.add('d-none');
                    btn.classList.add('btn-primary');
                    btn.classList.remove('btn-secondary');
                }
            }

            function clearError() {
                errorTitle.textContent = 'エクスポートに失敗しました';
                errorList.replaceChildren();
                errorBox.classList.add('d-none');
            }

            function showError(message, details) {
                // HTMLは使わず textContent だけで表示する
                errorTitle.textContent = message || 'エクスポートに失敗しました';
                errorList.replaceChildren();

                const items = Array.isArray(details) && details.length ? details : [];
                if (items.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = '通信状況をご確認のうえ、再度お試しください。';
                    errorList.appendChild(li);
                } else {
                    items.forEach((t) => {
                        const li = document.createElement('li');
                        li.textContent = String(t);
                        errorList.appendChild(li);
                    });
                }

                errorBox.classList.remove('d-none');
                errorBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            function getFileNameFromContentDisposition(headerValue) {
                if (!headerValue) return null;
                const matchQuoted = headerValue.match(/filename="([^"]+)"/i);
                if (matchQuoted && matchQuoted[1]) return matchQuoted[1];

                // 例: attachment; filename=xxx.csv
                const matchPlain = headerValue.match(/filename=([^;]+)/i);
                if (matchPlain && matchPlain[1]) return matchPlain[1].trim();

                // RFC 5987: filename*=UTF-8''...
                const matchStar = headerValue.match(/filename\*\s*=\s*UTF-8''([^;]+)/i);
                if (matchStar && matchStar[1]) {
                    try { return decodeURIComponent(matchStar[1]); } catch (e) { /* noop */ }
                }

                return null;
            }

            async function downloadByFetch() {
                setLoading(true);

                try {
                    const actionUrl = form.getAttribute('action') || window.location.href;
                    const method = (form.getAttribute('method') || 'POST').toUpperCase();

                    const formData = new FormData(form);

                    const res = await fetch(actionUrl, {
                        method,
                        body: formData,
                        credentials: 'same-origin',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    const contentType = (res.headers.get('Content-Type') || '').toLowerCase();

                    if (!res.ok) {
                        // JSONなら message/errors を採用。HTML等は捨てて一般メッセージにする
                        if (contentType.includes('application/json')) {
                            const payload = await res.json().catch(() => null);
                            showError(payload && payload.message ? payload.message : 'エクスポートに失敗しました', payload && payload.errors ? payload.errors : []);
                        } else {
                            showError('エクスポートに失敗しました', []);
                        }
                        return;
                    }

                    const blob = await res.blob();

                    // ファイル名をレスポンスヘッダから取得（なければフォールバック）
                    const cd = res.headers.get('Content-Disposition');
                    const fileName =
                        getFileNameFromContentDisposition(cd) ||
                        ('manifestations_' + new Date().toISOString().replaceAll(':', '-').slice(0, 19) + '.dat');

                    const url = window.URL.createObjectURL(blob);

                    try {
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    } finally {
                        // すぐ revoke すると環境によって失敗することがあるので少し遅らせる
                        setTimeout(() => window.URL.revokeObjectURL(url), 3000);
                    }
                } finally {
                    // ダウンロード開始処理が終わったら必ず戻す
                    setLoading(false);
                }
            }

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                downloadByFetch();
            });
        });
    </script>
{% endblock %}
