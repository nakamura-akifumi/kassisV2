{% extends 'base.html.twig' %}

{% block title %}ファイルエクスポート{% endblock %}

{% block body %}
    <div class="container py-2">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-primary text-white py-1">
                <h2 class="mb-0 fs-5 lh-1">ファイルエクスポート（Excel / CSV）</h2>
            </div>

            <div class="card-body p-3">
                <div class="alert alert-info small">
                    <p class="mb-0">エクスポート形式を選択して「エクスポート」ボタンを押してください。</p>
                    <p class="mb-0 mt-1">（検索条件がURLに付いている場合、その条件でエクスポートします）</p>
                </div>

                {{ form_start(form, {'attr': {'class': 'needs-validation'}}) }}

                {# 検索条件の引き継ぎ（GETパラメータをそのまま hidden で維持） #}
                {% for key, value in query %}
                    {% if value is not empty %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                {% endfor %}

                <div class="mb-3">
                    {{ form_label(form.format, null, {'label_attr': {'class': 'form-label small mb-2 fw-bold'}}) }}
                    {{ form_widget(form.format) }}
                    <div class="form-text text-danger small">
                        {{ form_errors(form.format) }}
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">1. 出力項目を選択してください</label>
                    <div class="row g-2">
                        {% set fields = [
                            'Id', 'Title', 'Transcription', 'Identifier', 'External_identifier1',
                            'External_identifier2', 'External_identifier3', 'Description', 'Buyer',
                            'Buyer_identifier', 'Purchase_date', 'RecordSource', 'Type1', 'Type2',
                            'Type3', 'Type4', 'Location1', 'Location2', 'Contributor1', 'Contributor2',
                            'Status1', 'Status2', 'ReleaseDateString', 'Price', 'CreatedAt', 'UpdatedAt'
                        ] %}
                        {% for field in fields %}
                            {% set fieldKey = field|first|lower ~ field|slice(1) %}
                            {% set isRequired = fieldKey in ['id', 'title', 'identifier'] %}
                            <div class="col-md-3 col-sm-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="{{ form.columns.vars.full_name }}[]"
                                               value="{{ fieldKey }}" id="col_{{ fieldKey }}"
                                               {% if isRequired %}checked disabled{% else %}checked{% endif %}>
                                    <label class="form-check-label" for="col_{{ fieldKey }}">
                                        {{ ('Model.Manifestation.fields.' ~ field) | trans }}
                                    </label>
                                    {# disabledな要素は送信されないため、必須項目はhiddenで確実に送る #}
                                    {% if isRequired %}
                                        <input type="hidden" name="{{ form.columns.vars.full_name }}[]" value="{{ fieldKey }}">
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                    <button type="submit" class="btn btn-primary btn-sm">
                        エクスポート
                    </button>
                    <a href="{{ path('app_manifestation_index') }}" class="btn btn-outline-secondary btn-sm">
                        一覧に戻る
                    </a>
                </div>

                {{ form_end(form) }}
            </div>
        </div>
    </div>
{% endblock %}
