{% extends 'base.html.twig' %}

{% block title %}{{ manifestation.title }} - 書誌詳細{% endblock %}

{% block stylesheets %}
    <style>
        .manifestation-detail {
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .manifestation-title {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 1.6rem;
        }

        .detail-table {
            width: 100%;
            margin-bottom: 0;
        }

        .detail-table tr {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .detail-table tr:last-child {
            border-bottom: none;
        }

        .detail-table th, .detail-table td {
            padding: 0.5rem 0.75rem;
            line-height: 1.3;
        }

        .detail-table th {
            width: 25%;
            color: #546e7a;
            font-weight: 600;
            font-size: 0.9rem;
            background-color: rgba(0, 0, 0, 0.02);
        }

        .book-cover {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 1rem;
        }

        .book-cover img {
            max-width: 100%;
            height: auto;
            max-height: 400px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .attachment-thumbnail {
            width: 100%;
            margin-top: 1rem;
            border-top: 1px solid #eee;
            padding-top: 1rem;
        }

        .attachment-thumbnail-item {
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .attachment-thumbnail-item img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
        }

        .attachment-thumbnail-item .pdf-link {
            display: block;
            padding: 1rem;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            color: #dc3545;
            text-decoration: none;
        }

        .attachment-thumbnail-item .pdf-link:hover {
            background-color: #e9ecef;
        }

        .action-buttons {
            margin-top: 1.5rem;
        }

        .action-buttons .btn {
            margin-right: 0.5rem;
        }

        .btn-warning {
            background-color: #f39c12;
            border-color: #f39c12;
            color: white;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .cover-fallback {
            width: 200px;
            height: 280px;
            background-color: #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #6c757d;
            font-size: 0.9rem;
            text-align: center;
            border-radius: 4px;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            background-color: #6c757d;
            margin-right: 0.5rem;
        }

        .status-active {
            background-color: #28a745;
        }

        .status-inactive {
            background-color: #6c757d;
        }

        .status-pending {
            background-color: #ffc107;
            color: #212529;
        }

        .status-deleted {
            background-color: #dc3545;
        }

        .status-sold {
            background-color: #17a2b8;
        }

        .status-loaned {
            background-color: #6f42c1;
        }

        .price-info {
            font-weight: 600;
            color: #e74c3c;
        }

        .attachment-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #dee2e6;
            font-size: 0.9rem;
        }

        .attachment-section h4 {
            font-size: 1rem;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .attachment-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
            color: #7f8c8d;
        }

        .attachment-info {
            flex-grow: 1;
        }

        .attachment-name {
            display: block;
            font-weight: 600;
            color: #2c3e50;
        }

        .attachment-meta {
            font-size: 0.8rem;
            color: #95a5a6;
        }

        .upload-form-card {
            background-color: #f1f3f5;
            border: 1px dashed #ced4da;
            padding: 1rem;
            border-radius: 8px;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container">
        <div class="manifestation-detail p-4">
            <h1 class="manifestation-title">
                {{ manifestation.title }}
            </h1>

            <div class="row">
                <div class="col-md-8">
                    <table class="detail-table">
                        <tbody>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Title' | trans }}</th>
                            <td>{{ manifestation.title }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Title_Transcription' | trans }}</th>
                            <td>{{ manifestation.titleTranscription }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Identifier' | trans }}</th>
                            <td>{{ manifestation.identifier }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.External_identifier1' | trans }}</th>
                            <td>{{ manifestation.externalIdentifier1 }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.External_identifier2' | trans }}</th>
                            <td>{{ manifestation.externalIdentifier2 }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.External_identifier3' | trans }}</th>
                            <td>{{ manifestation.externalIdentifier3 }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Contributor1' | trans }}</th>
                            <td>{{ manifestation.contributor1 }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Contributor2' | trans }}</th>
                            <td>{{ manifestation.contributor2 }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Class1' | trans }}</th>
                            <td>{{ manifestation.class1 }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Class2' | trans }}</th>
                            <td>{{ manifestation.class2 }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Description' | trans }}</th>
                            <td>{{ manifestation.description }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Buyer' | trans }}</th>
                            <td>{{ manifestation.buyer }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Buyer_identifier' | trans }}</th>
                            <td>{{ manifestation.buyerIdentifier }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Purchase_date' | trans }}</th>
                            <td>{{ manifestation.purchaseDate ? manifestation.purchaseDate|date('Y-m-d') : '' }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.ReleaseDateString' | trans }}</th>
                            <td>{{ manifestation.releaseDateString }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Price' | trans }}</th>
                            <td class="price-info">{{ manifestation.formattedPrice }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.PriceCurrency' | trans }}</th>
                            <td>{{ manifestation.priceCurrency }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Type1' | trans }}</th>
                            <td>{{ manifestation.type1 }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Type2' | trans }}</th>
                            <td>{{ manifestation.type2 }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Type3' | trans }}</th>
                            <td>{{ manifestation.type3 }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Type4' | trans }}</th>
                            <td>{{ manifestation.type4 }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Location1' | trans }}</th>
                            <td>{{ manifestation.location1 }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Location2' | trans }}</th>
                            <td>{{ manifestation.location2 }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Location3' | trans }}</th>
                            <td>{{ manifestation.location3 }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Status1' | trans }}</th>
                            <td>
                                {% set statusKey = 'Workflow.Manifestation.Status.' ~ manifestation.status1 %}
                                {% set statusLabel = statusKey|trans %}
                                {{ statusLabel == statusKey ? manifestation.status1 : statusLabel }}
                            </td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.Status2' | trans }}</th>
                            <td>
                                {{ manifestation.status2 }}
                            </td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.RecordSource' | trans }}</th>
                            <td>{{ manifestation.recordSource }}</td>
                        </tr>
                        <tr>
                            <th>{{ 'Model.Manifestation.fields.UpdatedAt' | trans }}</th>
                            <td>{{ manifestation.updatedAt ? manifestation.updatedAt|date('Y-m-d H:i:s') : '' }}</td>
                        </tr>
                        </tbody>
                    </table>

                    <div class="attachment-section">
                        <h4><i class="fas fa-paperclip"></i> 添付ファイル</h4>

                        {% if manifestation.attachments|length > 0 %}
                            <div class="mb-4">
                                {% for attachment in manifestation.attachments %}
                                    <div class="attachment-item">
                                        <div class="attachment-icon">
                                            {% if 'image' in attachment.mimeType %}
                                                <i class="fas fa-file-image"></i>
                                            {% elseif 'pdf' in attachment.mimeType %}
                                                <i class="fas fa-file-pdf"></i>
                                            {% else %}
                                                <i class="fas fa-file"></i>
                                            {% endif %}
                                        </div>
                                        <div class="attachment-info">
                                            <a href="{{ asset(attachment.filePath) }}" target="_blank" class="attachment-name">
                                                {{ attachment.fileName }}
                                            </a>
                                            <div class="attachment-meta">
                                                {{ (attachment.fileSize / 1024)|number_format(1) }} KB |
                                                {{ attachment.createdAt|date('Y-m-d H:i') }}
                                            </div>
                                        </div>
                                        <div class="attachment-actions">
                                            <form method="post" action="{{ path('app_manifestation_attachment_delete', {'id': attachment.id}) }}" style="display: inline-block" onsubmit="return confirm('このファイルを削除してもよろしいですか？');">
                                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ attachment.id) }}">
                                                <button class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">添付ファイルはありません。</p>
                        {% endif %}

                        <div class="upload-form-card">
                            <h6>新規ファイル添付</h6>
                            {{ form_start(attachment_form) }}
                                <div class="row align-items-end">
                                    <div class="col-md-9">
                                        {{ form_row(attachment_form.attachment) }}
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-success w-100 mb-3">
                                            <i class="fas fa-upload"></i> アップロード
                                        </button>
                                    </div>
                                </div>
                            {{ form_end(attachment_form) }}
                        </div>
                    </div>

                    <div class="action-buttons">
                        <a href="{{ path('app_manifestation_index') }}" class="btn btn-secondary">
                            <i class="fas fa-list"></i> 一覧に戻る
                        </a>
                        <a href="{{ path('app_manifestation_edit', {'id': manifestation.id}) }}" class="btn btn-primary">
                            <i class="fas fa-edit"></i> 編集
                        </a>
                        {% if manifestation.amazonUrl %}
                            <a href="{{ manifestation.amazonUrl }}" target="_blank" class="btn btn-warning">
                                <i class="fab fa-amazon"></i> Amazonで見る
                            </a>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="book-cover">
                        {% if manifestation.externalIdentifier1 %}
                            <div id="coverContainer">
                                <div class="loading-spinner" id="coverLoading"></div>
                                <div class="cover-fallback d-none" id="coverFallback">
                                    <p>書影が見つかりませんでした</p>
                                </div>
                                <img id="bookCover" class="d-none" alt="{{ manifestation.title }}の書影">
                            </div>
                            <p class="text-muted small mt-2">ISBN: {{ manifestation.externalIdentifier1 }}</p>
                        {% endif %}

                        {# 添付資料のプレビュー表示エリア #}
                        {% if manifestation.attachments|length > 0 %}
                                <div class="attachment-thumbnail">
                                    {% for attachment in manifestation.attachments %}
                                        {% if 'image' in attachment.mimeType or 'pdf' in attachment.mimeType %}
                                            <div class="attachment-thumbnail-item">
                                                {% if 'image' in attachment.mimeType %}
                                                    <a href="{{ asset(attachment.filePath) }}" target="_blank" title="{{ attachment.fileName }}">
                                                        <img src="{{ asset(attachment.filePath) }}" alt="{{ attachment.fileName }}">
                                                    </a>
                                                {% elseif 'pdf' in attachment.mimeType %}
                                                    <a href="{{ asset(attachment.filePath) }}" target="_blank" class="pdf-link">
                                                        <i class="fas fa-file-pdf fa-3x"></i>
                                                        <div class="small mt-2 text-dark">{{ attachment.fileName }}</div>
                                                        <div class="badge bg-danger mt-1">PDFを開く</div>
                                                    </a>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const isbn = "{{ manifestation.externalIdentifier1 }}";
                if (isbn) {
                    checkAndLoadBookCover(isbn);
                } else {
                    showFallback();
                }

                function checkAndLoadBookCover(isbn) {
                    const cleanIsbn = isbn.replace(/-/g, '');
                    const googleUrl = `https://www.googleapis.com/books/v1/volumes?q=isbn:${cleanIsbn}`;

                    fetch(googleUrl)
                        .then(response => response.json())
                        .then(data => {
                            if (data.totalItems > 0 && data.items[0].volumeInfo.imageLinks) {
                                const imgUrl = data.items[0].volumeInfo.imageLinks.thumbnail.replace('http:', 'https:');
                                const img = document.getElementById('bookCover');
                                img.src = imgUrl;
                                img.onload = function() {
                                    document.getElementById('coverLoading').classList.add('d-none');
                                    img.classList.remove('d-none');
                                };
                            } else {
                                showFallback();
                            }
                        })
                        .catch(error => {
                            console.error('Google Books API Error:', error);
                            showFallback();
                        });
                }

                function showFallback() {
                document.getElementById('coverLoading').classList.add('d-none');
                document.getElementById('coverFallback').classList.remove('d-none');
                document.getElementById('bookCover').classList.add('d-none');
            }
        });
    </script>
{% endblock %}
