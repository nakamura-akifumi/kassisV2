{% if (view_mode|default('list')) == 'list' %}
    {% if manifestations|length > 50 %}
        <div class="alert alert-info py-2 mb-1">
            <i class="fas fa-info-circle"></i> 検索結果が50件を超えています。最初の50件のみ表示しています。
        </div>
    {% endif %}
    <table class="table">
        <thead>
            <tr>
                <th>{{ 'Model.Manifestation.fields.Title' | trans }}</th>
                <th>{{ 'Model.Manifestation.fields.Identifier' | trans }}</th>
                <th>{{ 'Model.Manifestation.fields.External_identifier1' | trans }}</th>
                <th>{{ 'Model.Manifestation.fields.Purchase_date' | trans }}</th>
            </tr>
        </thead>
        <tbody>
        {% for manifestation in manifestations|slice(0, 50) %}
            <tr>
                <td><a href="{{ path('app_manifestation_show', {'id': manifestation.id}) }}">{{ manifestation.title }}</a></td>
                <td>{{ manifestation.identifier }}</td>
                <td>{{ manifestation.externalIdentifier1 }}</td>
                <td>{{ manifestation.purchaseDate ? manifestation.purchaseDate|date('Y-m-d') : '' }}</td>
            </tr>
        {% else %}
            <tr><td colspan="4">{{ 'Screen.Manifestation.NoRecordFound' | trans }}</td></tr>
        {% endfor %}
        </tbody>
    </table>
{% elseif view_mode == 'panel' %}
    {% if manifestations|length > 20 %}
        <div class="alert alert-info py-2 mb-1">
            <i class="fas fa-info-circle"></i> 検索結果が20件を超えています。最初の20件のみ表示しています。全件確認するにはリスト表示をご利用ください。
        </div>
    {% endif %}
    <div class="panel-container">
        {% for manifestation in manifestations|slice(0, 20) %}
            <a href="{{ path('app_manifestation_show', {'id': manifestation.id}) }}" class="panel-item text-decoration-none text-dark">
                <div class="panel-image-container">
                    {% set first_image = null %}
                    {% for attachment in manifestation.attachments %}
                        {% if first_image is null and 'image' in attachment.mimeType %}
                            {% set first_image = asset(attachment.filePath) %}
                        {% endif %}
                    {% endfor %}

                    {% if manifestation.externalIdentifier1 %}
                        {# 初期状態はローディングか非表示、JSでURLをセットする #}
                        <img src="" alt="{{ manifestation.title }}" 
                             id="img-isbn-{{ manifestation.id }}" 
                             data-isbn="{{ manifestation.externalIdentifier1|replace({'-': ''}) }}"
                             class="d-none manifestation-panel-img">
                        
                        {# フォールバック（添付画像またはアイコン） #}
                        <div id="img-fallback-{{ manifestation.id }}" class="{{ first_image ? '' : 'd-flex align-items-center justify-content-center h-100' }}">
                            {% if first_image %}
                                <img src="{{ first_image }}" alt="{{ manifestation.title }}">
                            {% else %}
                                <i class="fas fa-book fa-3x text-light-emphasis"></i>
                            {% endif %}
                        </div>
                    {% elseif first_image %}
                        <img src="{{ first_image }}" alt="{{ manifestation.title }}">
                    {% else %}
                        <i class="fas fa-book fa-3x text-light-emphasis"></i>
                    {% endif %}
                </div>
                <div class="fw-bold text-truncate" title="{{ manifestation.title }}">{{ manifestation.title }}</div>
                <small class="text-muted">{{ manifestation.identifier }}</small>
            </a>
        {% endfor %}
    </div>
{% elseif view_mode == 'map' %}
    {% if manifestations|length > 20 %}
        <div class="alert alert-info py-2 mb-1">
            <i class="fas fa-info-circle"></i> 検索結果が20件を超えています。最初の20件のみ表示しています。
        </div>
    {% endif %}
    <div class="map-layout">
        <div id="map-container" class="map-container"></div>
        <div class="map-results">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>{{ 'Model.Manifestation.fields.Title' | trans }}</th>
                        <th>{{ 'Model.Manifestation.fields.Identifier' | trans }}</th>
                        <th>{{ 'Model.Manifestation.fields.External_identifier1' | trans }}</th>
                        <th>{{ 'Model.Manifestation.fields.Purchase_date' | trans }}</th>
                    </tr>
                </thead>
                <tbody>
                {% for manifestation in manifestations|slice(0, 20) %}
                    <tr>
                        <td><a href="{{ path('app_manifestation_show', {'id': manifestation.id}) }}">{{ manifestation.title }}</a></td>
                        <td>{{ manifestation.identifier }}</td>
                        <td>{{ manifestation.externalIdentifier1 }}</td>
                        <td>{{ manifestation.purchaseDate ? manifestation.purchaseDate|date('Y-m-d') : '' }}</td>
                    </tr>
                {% else %}
                    <tr><td colspan="4">{{ 'Screen.Manifestation.NoRecordFound' | trans }}</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <script type="application/json" id="map-data">
        [
        {% for manifestation in manifestations|slice(0, 20) %}
            {"id": {{ manifestation.id }}, "title": {{ manifestation.title|json_encode|raw }}, "identifier": {{ manifestation.identifier|json_encode|raw }}, "location3": {{ manifestation.location3|default('')|json_encode|raw }}, "url": {{ path('app_manifestation_show', {'id': manifestation.id})|json_encode|raw }} }{% if not loop.last %},{% endif %}
        {% endfor %}
        ]
    </script>
{% endif %}
