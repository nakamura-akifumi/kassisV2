{% extends 'base.html.twig' %}

{% block title %}{{ 'Screen.Manifestation.Index'|trans }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .view-mode-buttons .btn.active { background-color: #007bff; color: white; }
        .panel-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .panel-item { width: calc(25% - 15px); text-align: center; border: 1px solid #ddd; padding: 10px; border-radius: 8px; transition: background-color 0.2s, transform 0.2s; display: block; }
        .panel-item:hover { background-color: #f8f9fa; border-color: #007bff; transform: translateY(-2px); text-decoration: none; }
        .panel-item .panel-image-container { width: 100%; height: 180px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; background-color: #f1f3f5; border-radius: 4px; overflow: hidden; }
        .panel-item img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #grid-container { width: 100%; height: 600px; border: 1px solid #ddd; }

        /* 追加: 詳細ポップアップ（モーダル）を小さめフォントに */
        #manifestationDetailModal .modal-body {
            font-size: 0.85rem;
            line-height: 1.35;
        }
        #manifestationDetailModal .kv dt {
            font-weight: 700;
        }
        #manifestationDetailModal .kv dd {
            margin-bottom: 0.35rem;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container mt-4">
        <!-- 検索フォーム -->
        <div class="card mt-4 mb-4">
            <div class="card-header">
                <h5>書誌検索</h5>
            </div>

            <div class="card-body">
                <form action="{{ path('app_manifestation_index') }}" method="get" id="search_form">
                    <input type="hidden" name="mode" id="search_mode" value="{{ search_params.mode|default('simple') }}">

                    <div class="mb-3">
                        {# モード1: キーワード入力 (Simple) #}
                        <div id="wrapper_q_simple" class="search-wrapper">
                            <label for="search_q_single" class="form-label small fw-bold">キーワード検索</label>
                            <input type="text" name="q" id="search_q_single" class="form-control"
                                   value="{{ search_params.q|default('') }}" placeholder="キーワードを入力...">
                        </div>

                        {# モード2: 複数識別子 (Multi) #}
                        <div id="wrapper_q_multi" class="search-wrapper d-none">
                            <label for="search_q_multi" class="form-label small fw-bold">識別子を複数検索（1行1件）</label>
                            <textarea name="q" id="search_q_multi" class="form-control"
                                      rows="5" placeholder="1行に1つの識別子を入力..." disabled>{{ search_params.q|default('') }}</textarea>
                        </div>

                        {# モード3: 詳細検索 (Advanced) #}
                        <div id="wrapper_advanced" class="search-wrapper d-none">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">識別子（前方一致）</label>
                                    <input type="text" name="identifier" class="form-control" value="{{ search_params.identifier|default('') }}" disabled>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">タイプ1（完全一致）</label>
                                    <input type="text" name="type1" class="form-control" value="{{ search_params.type1|default('') }}" disabled>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">タイプ2（完全一致）</label>
                                    <input type="text" name="type2" class="form-control" value="{{ search_params.type2|default('') }}" disabled>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button class="btn btn-outline-secondary btn-sm" type="button" id="toggle_search_mode">
                            <i class="bi bi-gear"></i> モード切替
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> {{ 'Model.actions.search'|trans|default('検索実行') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>

            <div class="view-mode-buttons d-flex justify-content-between align-items-center">
                <div>
                    <span class="me-2">表示切替:</span>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-view-mode {{ (view_mode|default('list')) == 'list' ? 'active' : '' }}" data-mode="list" title="リスト方式">
                            <i class="fas fa-list"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-view-mode {{ (view_mode|default('list')) == 'panel' ? 'active' : '' }}" data-mode="panel" title="パネル方式">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-view-mode {{ (view_mode|default('list')) == 'grid' ? 'active' : '' }}" data-mode="grid" title="グリッド形式">
                            <i class="fas fa-table"></i>
                        </button>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-secondary me-3" id="result-count">
                            検索結果: {{ manifestations|length }} 件
                    </span>
                    <button type="button" id="btn-export" class="btn btn-outline-success">
                        <i class="fas fa-file-export"></i> エクスポート
                    </button>
                </div>
            </div>

            <!-- 検索結果を表示するエリア -->
            <div id="search-results" class="mt-4">
                {% if (view_mode|default('list')) != 'grid' %}
                    {% include 'manifestation/_results_list.html.twig' %}
                {% else %}
                    <div id="grid-container" class="grid-sample" style="height: 600px;"></div>
                {% endif %}
            </div>

            <!-- 追加: 詳細表示モーダル -->
            <div class="modal fade" id="manifestationDetailModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header py-2">
                            <h5 class="modal-title mb-0" id="manifestationDetailModalTitle">Manifestation 詳細</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="manifestationDetailModalBody" class="small text-muted">
                                読み込み中...
                            </div>
                        </div>
                        <div class="modal-footer py-2">
                            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">閉じる</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ローディングインジケーター (不足していた要素を追加) -->
            <div id="loading" class="text-center d-none my-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">読み込み中...</span>
                </div>
            </div>
        </div>
    {% endblock %}

    {% block javascripts %}
        {{ parent() }}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                let grid = null;

                const searchForm = document.getElementById('search_form');
                const searchResults = document.getElementById('search-results');
                const loading = document.getElementById('loading');

                const modeInput = document.getElementById('search_mode');
                const toggleBtn = document.getElementById('toggle_search_mode');

                const wrappers = {
                    'simple': document.getElementById('wrapper_q_simple'),
                    'multi': document.getElementById('wrapper_q_multi'),
                    'advanced': document.getElementById('wrapper_advanced')
                };

                function switchMode(newMode) {
                    Object.keys(wrappers).forEach(m => {
                        const isTarget = (m === newMode);
                        wrappers[m].classList.toggle('d-none', !isTarget);
                        wrappers[m].querySelectorAll('input, textarea, select').forEach(el => el.disabled = !isTarget);
                    });
                    modeInput.value = newMode;
                }

                switchMode(modeInput.value);

                toggleBtn.addEventListener('click', function() {
                    const current = modeInput.value;
                    let next = 'simple';
                    if (current === 'simple') next = 'multi';
                    else if (current === 'multi') next = 'advanced';
                    switchMode(next);
                });

                function escapeHtml(str) {
                    if (str === null || str === undefined) return '';
                    return String(str)
                        .replaceAll('&', '&amp;')
                        .replaceAll('<', '&lt;')
                        .replaceAll('>', '&gt;')
                        .replaceAll('"', '&quot;')
                        .replaceAll("'", '&#039;');
                }

                function renderKeyValueDl(data, items) {
                    const rows = items
                        .filter(it => data[it.key] !== null && data[it.key] !== undefined && String(data[it.key]).trim() !== '')
                        .map(it => `<dt class="col-4">${escapeHtml(it.label)}</dt><dd class="col-8">${escapeHtml(data[it.key])}</dd>`)
                        .join('');
                    return `<dl class="row kv mb-0">${rows || '<div class="text-muted">表示できる詳細情報がありません。</div>'}</dl>`;
                }

                async function openManifestationPopup(id) {
                    const modalEl = document.getElementById('manifestationDetailModal');
                    const titleEl = document.getElementById('manifestationDetailModalTitle');
                    const bodyEl = document.getElementById('manifestationDetailModalBody');
                    if (!modalEl || !titleEl || !bodyEl) return;

                    titleEl.textContent = 'Manifestation 詳細';
                    bodyEl.textContent = '読み込み中...';

                    if (window.bootstrap && window.bootstrap.Modal) {
                        window.bootstrap.Modal.getOrCreateInstance(modalEl).show();
                    }

                    try {
                        const url = '{{ path('app_manifestation_popup', {'id': 0}) }}'.replace(/0\/popup$/, String(id) + '/popup');
                        const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                        if (!res.ok) throw new Error('HTTP ' + res.status);

                        const data = await res.json();

                        titleEl.textContent = `Manifestation #${data.id}: ${data.title || ''}`.trim();
                        bodyEl.innerHTML = renderKeyValueDl(data, [
                            { key: 'identifier', label: '識別子' },
                            { key: 'titleTranscription', label: 'タイトル（読み）' },
                            { key: 'externalIdentifier1', label: '外部ID1' },
                            { key: 'externalIdentifier2', label: '外部ID2' },
                            { key: 'externalIdentifier3', label: '外部ID3' },
                            { key: 'purchaseDate', label: '購入日' },
                            { key: 'buyer', label: '購入者' },
                            { key: 'buyerIdentifier', label: '購入者識別子' },
                            { key: 'type1', label: 'タイプ1' },
                            { key: 'type2', label: 'タイプ2' },
                            { key: 'location1', label: 'ロケーション1' },
                            { key: 'location2', label: 'ロケーション2' },
                            { key: 'location3', label: 'ロケーション3' },
                            { key: 'contributor1', label: '著者/寄与者1' },
                            { key: 'contributor2', label: '著者/寄与者2' },
                            { key: 'releaseDateString', label: '出版日（文字列）' },
                            { key: 'price', label: '価格' },
                            { key: 'status1', label: 'ステータス1' },
                            { key: 'status2', label: 'ステータス2' },
                            { key: 'updatedAt', label: '更新日時' },
                            { key: 'description', label: '説明' },
                        ]);
                    } catch (e) {
                        bodyEl.innerHTML = '<div class="alert alert-danger py-2 mb-0 small">詳細情報の取得に失敗しました。再度お試しください。</div>';
                    }
                }

                function renderGrid(records) {
                    const parentElement = document.getElementById("grid-container");
                    if (!parentElement) return;

                    const normalizedRecords = (records || []).map(r => Object.assign({ __detail: '詳' }, r));

                    const header = [
                        {
                            field: "__detail",
                            caption: "",
                            width: 48,
                            style: {
                                textAlign: "center",
                                bgColor: "#e9f2ff",   // ボタンっぽい背景
                                color: "#0d6efd",     // Bootstrap primary 相当
                            },
                        },
                        { field: "id", caption: "ID", width: 60 },
                        { field: "title", caption: "タイトル", width: 300 },
                        { field: "identifier", caption: "識別子", width: 150 },
                        { field: "externalIdentifier1", caption: "外部ID1", width: 150 },
                        { field: "purchaseDate", caption: "購入日", width: 120 },
                    ];

                    if (grid) {
                        grid.records = normalizedRecords;
                        return;
                    }

                    grid = new cheetahGrid.ListGrid({
                        parentElement: parentElement,
                        header: header,
                        records: normalizedRecords,
                        frozenColCount: 2, // 左端「詳」＋IDを固定
                    });

                    // 追加：コンソールから触れるようにする
                    window.__manifestationGrid = grid;

                    // 追加：デバッグ用
                    grid.listen('click_cell', function(a) { console.log('click_cell', a); });

                    grid.listen('click_cell', function(args) {
                        if (!args) return;
                        if (args.col !== 0) return;

                        // args.record が無い環境向け：row から取る（rowが1始まりなので -1 補正）
                        let rec = args.record || null;
                        if (!rec && grid.records && typeof args.row === 'number') {
                            const idx = Math.max(0, args.row - 1);
                            rec = grid.records[idx] || null;
                        }

                        const id = rec && rec.id ? rec.id : null;
                        if (!id) return;

                        openManifestationPopup(id);
                    });

                    // ホバーで「ボタン」感（カーソル）
                    grid.listen('mousemove_cell', function(args) {
                        if (!args) return;
                        parentElement.style.cursor = (args.col === 0) ? 'pointer' : '';
                    });
                    grid.listen('mouseleave_grid', function() {
                        parentElement.style.cursor = '';
                    });

                }

                // 表示切替
                document.querySelectorAll('.btn-view-mode').forEach(button => {
                    button.addEventListener('click', function() {
                        const newMode = this.getAttribute('data-mode');

                        let vm = searchForm.querySelector('input[name="view_mode"]');
                        if (!vm) {
                            vm = document.createElement('input');
                            vm.type = 'hidden';
                            vm.name = 'view_mode';
                            searchForm.appendChild(vm);
                        }
                        vm.value = newMode;
                        searchForm.submit();
                    });
                });

                // エクスポート
                const exportBtnEl = document.getElementById('btn-export');
                if (exportBtnEl) {
                    exportBtnEl.addEventListener('click', function() {
                        const formData = new FormData(searchForm);
                        const queryParams = new URLSearchParams(formData);
                        queryParams.delete('view_mode');
                        window.location.href = '{{ path('app_manifestation_file_export') }}?' + queryParams.toString();
                    });
                }

                // 検索（AJAX）
                searchForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const formData = new FormData(searchForm);
                    const viewMode = '{{ view_mode|default("list") }}';
                    formData.set('view_mode', viewMode);
                    const queryParams = new URLSearchParams(formData);

                    loading.classList.remove('d-none');

                    fetch('{{ path('app_manifestation_search') }}?' + queryParams.toString(), {
                        method: 'GET',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                        .then(response => (viewMode === 'grid' ? response.json() : response.text()))
                        .then(data => {
                            loading.classList.add('d-none');
                            if (viewMode === 'grid') renderGrid(data);
                            else searchResults.innerHTML = data;
                        });
                });

                // 初期状態が grid の場合は自動実行
                if ('{{ view_mode|default("list") }}' === 'grid') {
                    searchForm.dispatchEvent(new Event('submit'));
                }
            });
        </script>
    {% endblock %}
