{% extends 'base.html.twig' %}

{% block title %}{{ 'Screen.Manifestation.Index'|trans }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
    <style>
        .view-mode-buttons .btn.active { background-color: #007bff; color: white; }
        .panel-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .panel-item { width: calc(25% - 15px); text-align: center; border: 1px solid #ddd; padding: 10px; border-radius: 8px; transition: background-color 0.2s, transform 0.2s; display: block; }
        .panel-item:hover { background-color: #f8f9fa; border-color: #007bff; transform: translateY(-2px); text-decoration: none; }
        .panel-item .panel-image-container { width: 100%; height: 180px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; background-color: #f1f3f5; border-radius: 4px; overflow: hidden; }
        .panel-item img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #grid-container { width: 100%; height: 600px; border: 1px solid #ddd; }
        .map-layout { display: grid; grid-template-columns: minmax(280px, 1fr) minmax(280px, 1fr); gap: 16px; }
        .map-container { width: 100%; height: 520px; border: 1px solid #ddd; border-radius: 6px; }
        .map-results { overflow: auto; max-height: 520px; border: 1px solid #eee; border-radius: 6px; padding: 8px; }
        @media (max-width: 992px) {
            .map-layout { grid-template-columns: 1fr; }
            .map-container { height: 360px; }
            .map-results { max-height: none; }
        }

        /* 追加: 詳細ポップアップ（モーダル）を小さめフォントに */
        #manifestationDetailModal .modal-body {
            font-size: 0.85rem;
            line-height: 1.35;
        }
        #manifestationDetailModal .kv dt {
            font-weight: 700;
        }
        #manifestationDetailModal .kv dd {
            margin-bottom: 0.35rem;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container mt-1">
        <!-- 検索フォーム -->
        <div class="card mt-2 mb-2">
            <div class="card-header py-1">
                <h5 class="mb-0 fs-6">書誌検索</h5>
            </div>

            <div class="card-body">
                <form action="{{ path('app_manifestation_index') }}" method="get" id="search_form">
                    <input type="hidden" name="mode" id="search_mode" value="{{ search_params.mode|default('simple') }}">

                    <div class="mb-3">
                        {# モード1: キーワード入力 (Simple) #}
                        <div id="wrapper_q_simple" class="search-wrapper">
                            <label for="search_q_single" class="form-label small fw-bold">キーワード検索</label>
                            <input type="text" name="q" id="search_q_single" class="form-control"
                                   value="{{ search_params.q|default('') }}" placeholder="キーワードを入力...">
                        </div>

                        {# モード2: 複数識別子 (Multi) #}
                        <div id="wrapper_q_multi" class="search-wrapper d-none">
                            <label for="search_q_multi" class="form-label small fw-bold">識別子を複数検索（1行1件）</label>
                            <textarea name="q" id="search_q_multi" class="form-control"
                                      rows="5" placeholder="1行に1つの識別子を入力..." disabled>{{ search_params.q|default('') }}</textarea>
                        </div>

                        {# モード3: 詳細検索 (Advanced) #}
                        <div id="wrapper_advanced" class="search-wrapper d-none">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">識別子（前方一致）</label>
                                    <input type="text" name="identifier" class="form-control" value="{{ search_params.identifier|default('') }}" disabled>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">タイプ1（完全一致）</label>
                                    <input type="text" name="type1" class="form-control" value="{{ search_params.type1|default('') }}" disabled>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">タイプ2（完全一致）</label>
                                    <input type="text" name="type2" class="form-control" value="{{ search_params.type2|default('') }}" disabled>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button class="btn btn-outline-secondary btn-sm py-1" type="button" id="toggle_search_mode" accesskey="m" title="Alt+M">
                            <i class="bi bi-gear"></i> モード切替
                        </button>
                        <button type="submit" class="btn btn-primary btn-sm py-1">
                            <i class="bi bi-search"></i> {{ 'Model.actions.search'|trans|default('検索実行') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>

            <div class="view-mode-buttons d-flex justify-content-between align-items-center">
                <div>
                    <span class="me-2">表示切替:</span>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-view-mode {{ (view_mode|default('list')) == 'list' ? 'active' : '' }}" data-mode="list" title="リスト方式">
                            <i class="fas fa-list"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-view-mode {{ (view_mode|default('list')) == 'panel' ? 'active' : '' }}" data-mode="panel" title="パネル方式">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-view-mode {{ (view_mode|default('list')) == 'grid' ? 'active' : '' }}" data-mode="grid" title="グリッド形式">
                            <i class="fas fa-table"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-view-mode {{ (view_mode|default('list')) == 'map' ? 'active' : '' }}" data-mode="map" title="地図表示">
                            <i class="fas fa-map"></i>
                        </button>
                    </div>
                </div>
                {% set current_sort = search_params.sort|default('created_at_asc') %}
                <div class="d-flex align-items-center">
                    <span class="badge bg-secondary me-3" id="result-count">
                            検索結果: {{ manifestations|length }} 件
                    </span>
                    <button type="button" id="btn-export" class="btn btn-outline-success">
                        <i class="fas fa-file-export"></i> エクスポート
                    </button>
                    <div class="ms-3">
                        <select name="sort" class="form-select form-select-sm" form="search_form">
                            <option value="created_at_asc" {{ current_sort == 'created_at_asc' ? 'selected' : '' }}>情報作成の昇順</option>
                            <option value="created_at_desc" {{ current_sort == 'created_at_desc' ? 'selected' : '' }}>情報作成の降順</option>
                            <option value="title_asc" {{ current_sort == 'title_asc' ? 'selected' : '' }}>タイトル名の50音順</option>
                            <option value="title_desc" {{ current_sort == 'title_desc' ? 'selected' : '' }}>タイトル名の50音降順</option>
                            <option value="identifier_asc" {{ current_sort == 'identifier_asc' ? 'selected' : '' }}>識別子の昇順</option>
                            <option value="identifier_desc" {{ current_sort == 'identifier_desc' ? 'selected' : '' }}>識別子の降順</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 検索結果を表示するエリア -->
            <div id="search-results" class="mt-2">
                {% if (view_mode|default('list')) != 'grid' %}
                    {% include 'manifestation/_results_list.html.twig' %}
                {% else %}
                    <div id="grid-container" class="grid-sample" style="height: 600px;"></div>
                {% endif %}
            </div>

            <!-- 追加: 詳細表示モーダル -->
            <div class="modal fade" id="manifestationDetailModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header py-2">
                            <h5 class="modal-title mb-0" id="manifestationDetailModalTitle">Manifestation 詳細</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="manifestationDetailModalBody" class="small text-muted">
                                読み込み中...
                            </div>
                        </div>
                        <div class="modal-footer py-2">
                            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">閉じる</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ローディングインジケーター (不足していた要素を追加) -->
            <div id="loading" class="text-center d-none my-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">読み込み中...</span>
                </div>
            </div>
        </div>
    {% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let grid = null;
            let activeMap = null;

                const searchForm = document.getElementById('search_form');
                const searchResults = document.getElementById('search-results');
                const loading = document.getElementById('loading');
                const sortSelect = document.querySelector('select[name="sort"]');

                const modeInput = document.getElementById('search_mode');
                const toggleBtn = document.getElementById('toggle_search_mode');

                const wrappers = {
                    'simple': document.getElementById('wrapper_q_simple'),
                    'multi': document.getElementById('wrapper_q_multi'),
                    'advanced': document.getElementById('wrapper_advanced')
                };

                function switchMode(newMode) {
                    Object.keys(wrappers).forEach(m => {
                        const isTarget = (m === newMode);
                        wrappers[m].classList.toggle('d-none', !isTarget);
                        wrappers[m].querySelectorAll('input, textarea, select').forEach(el => el.disabled = !isTarget);
                    });
                    modeInput.value = newMode;
                    focusFirstSearchInput();
                }

                function focusFirstSearchInput() {
                    if (!searchForm) return;
                    const target = searchForm.querySelector('.search-wrapper:not(.d-none) input:not([disabled]), .search-wrapper:not(.d-none) textarea:not([disabled])');
                    if (target) {
                        target.focus();
                    }
                }

                switchMode(modeInput.value);
                focusFirstSearchInput();

                toggleBtn.addEventListener('click', function() {
                    const current = modeInput.value;
                    let next = 'simple';
                    if (current === 'simple') next = 'multi';
                    else if (current === 'multi') next = 'advanced';
                    switchMode(next);
                });

                document.addEventListener('keydown', function(e) {
                    if (!e.altKey || e.ctrlKey || e.metaKey) return;
                    if (e.key !== 'm' && e.key !== 'M') return;
                    e.preventDefault();
                    toggleBtn.click();
                });

                function escapeHtml(str) {
                    if (str === null || str === undefined) return '';
                    return String(str)
                        .replaceAll('&', '&amp;')
                        .replaceAll('<', '&lt;')
                        .replaceAll('>', '&gt;')
                        .replaceAll('"', '&quot;')
                        .replaceAll("'", '&#039;');
                }

                function loadPanelImages() {
                    document.querySelectorAll('.manifestation-panel-img').forEach(img => {
                        const isbn = img.getAttribute('data-isbn');
                        const id = img.id.replace('img-isbn-', '');
                        const fallback = document.getElementById('img-fallback-' + id);

                        if (!isbn) return;

                        fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.totalItems > 0 && data.items && data.items[0].volumeInfo.imageLinks && data.items[0].volumeInfo.imageLinks.thumbnail) {
                                    const imgUrl = data.items[0].volumeInfo.imageLinks.thumbnail.replace('http:', 'https:');
                                    img.src = imgUrl;
                                    img.onload = () => {
                                        if (img.naturalWidth > 1) {
                                            img.classList.remove('d-none');
                                            if (fallback) fallback.classList.add('d-none');
                                        }
                                    };
                                }
                            })
                            .catch(err => console.error('Google Books API Error for ' + isbn, err));
                    });
                }

                function parseLocation3(value) {
                    if (!value) return null;
                    const parts = String(value).split(/[\\/,\s]+/).filter(Boolean);
                    if (parts.length < 2) return null;
                    const lat = parseFloat(parts[0]);
                    const lng = parseFloat(parts[1]);
                    if (!Number.isFinite(lat) || !Number.isFinite(lng)) return null;
                    if (lat < -90 || lat > 90 || lng < -180 || lng > 180) return null;
                    return [lat, lng];
                }

                function initMapView() {
                    const mapElement = document.getElementById('map-container');
                    if (!mapElement || !window.L) return;

                    const dataEl = document.getElementById('map-data');
                    let items = [];
                    if (dataEl && dataEl.textContent) {
                        try {
                            items = JSON.parse(dataEl.textContent);
                        } catch (e) {
                            items = [];
                        }
                    }

                    if (activeMap) {
                        activeMap.remove();
                        activeMap = null;
                    }

                    activeMap = L.map(mapElement);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors',
                        maxZoom: 19,
                    }).addTo(activeMap);

                    const bounds = [];
                    items.forEach(item => {
                        const coords = parseLocation3(item.location3);
                        if (!coords) return;
                        bounds.push(coords);
                        const title = escapeHtml(item.title || '');
                        const link = item.url ? `<a href="${escapeHtml(item.url)}">${title || '詳細'}</a>` : title;
                        L.marker(coords).addTo(activeMap).bindPopup(link);
                    });

                    if (bounds.length > 0) {
                        activeMap.fitBounds(bounds, { padding: [24, 24] });
                    } else {
                        activeMap.setView([35.681, 139.767], 11);
                    }
                }

                function renderKeyValueDl(data, items) {
                    const rows = items
                        .filter(it => data[it.key] !== null && data[it.key] !== undefined && String(data[it.key]).trim() !== '')
                        .map(it => `<dt class="col-4">${escapeHtml(it.label)}</dt><dd class="col-8">${escapeHtml(data[it.key])}</dd>`)
                        .join('');
                    return `<dl class="row kv mb-0">${rows || '<div class="text-muted">表示できる詳細情報がありません。</div>'}</dl>`;
                }

                async function openManifestationPopup(id) {
                    const modalEl = document.getElementById('manifestationDetailModal');
                    const titleEl = document.getElementById('manifestationDetailModalTitle');
                    const bodyEl = document.getElementById('manifestationDetailModalBody');
                    if (!modalEl || !titleEl || !bodyEl) return;

                    titleEl.textContent = 'Manifestation 詳細';
                    bodyEl.textContent = '読み込み中...';

                    if (window.bootstrap && window.bootstrap.Modal) {
                        window.bootstrap.Modal.getOrCreateInstance(modalEl).show();
                    }

                    try {
                        const url = '{{ path('app_manifestation_popup', {'id': 0}) }}'.replace(/0\/popup$/, String(id) + '/popup');
                        const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                        if (!res.ok) throw new Error('HTTP ' + res.status);

                        const data = await res.json();

                        titleEl.textContent = `Manifestation #${data.id}: ${data.title || ''}`.trim();
                        bodyEl.innerHTML = renderKeyValueDl(data, [
                            { key: 'identifier', label: '識別子' },
                            { key: 'titleTranscription', label: 'タイトル（読み）' },
                            { key: 'externalIdentifier1', label: '外部ID1' },
                            { key: 'externalIdentifier2', label: '外部ID2' },
                            { key: 'externalIdentifier3', label: '外部ID3' },
                            { key: 'purchaseDate', label: '購入日' },
                            { key: 'buyer', label: '購入者' },
                            { key: 'buyerIdentifier', label: '購入者識別子' },
                            { key: 'type1', label: 'タイプ1' },
                            { key: 'type2', label: 'タイプ2' },
                            { key: 'location1', label: 'ロケーション1' },
                            { key: 'location2', label: 'ロケーション2' },
                            { key: 'location3', label: 'ロケーション3' },
                            { key: 'contributor1', label: '著者/寄与者1' },
                            { key: 'contributor2', label: '著者/寄与者2' },
                            { key: 'releaseDateString', label: '出版日（文字列）' },
                            { key: 'price', label: '価格' },
                            { key: 'priceCurrency', label: '通貨' },
                            { key: 'status1', label: 'ステータス1' },
                            { key: 'status2', label: 'ステータス2' },
                            { key: 'updatedAt', label: '更新日時' },
                            { key: 'description', label: '説明' },
                        ]);
                    } catch (e) {
                        bodyEl.innerHTML = '<div class="alert alert-danger py-2 mb-0 small">詳細情報の取得に失敗しました。再度お試しください。</div>';
                    }
                }

                function renderGrid(records) {
                    const parentElement = document.getElementById("grid-container");
                    if (!parentElement) return;

                    const normalizedRecords = (records || []).map(r => Object.assign({ __detail: '詳' }, r));

                    const header = [
                        {
                            field: "__detail",
                            caption: "",
                            width: 48,
                            style: {
                                textAlign: "center",
                                bgColor: "#e9f2ff",   // ボタンっぽい背景
                                color: "#0d6efd",     // Bootstrap primary 相当
                            },
                        },
                        { field: "id", caption: "ID", width: 60 },
                        { field: "title", caption: "タイトル", width: 300 },
                        { field: "identifier", caption: "識別子", width: 150 },
                        { field: "externalIdentifier1", caption: "外部ID1", width: 150 },
                        { field: "purchaseDate", caption: "購入日", width: 120 },
                    ];

                    if (grid) {
                        grid.records = normalizedRecords;
                        return;
                    }

                    grid = new cheetahGrid.ListGrid({
                        parentElement: parentElement,
                        header: header,
                        records: normalizedRecords,
                        frozenColCount: 2, // 左端「詳」＋IDを固定
                        defaultRowHeight: 28,
                        headerRowHeight: 28,
                        theme: {
                            defaultStyle: {
                                font: '12px "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif',
                            },
                            header: {
                                defaultStyle: {
                                    font: '12px "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif',
                                },
                            },
                        },
                    });

                    // 追加：コンソールから触れるようにする
                    window.__manifestationGrid = grid;

                    // 追加：デバッグ用
                    grid.listen('click_cell', function(a) { console.log('click_cell', a); });

                    grid.listen('click_cell', function(args) {
                        if (!args) return;
                        if (args.col !== 0) return;

                        // args.record が無い環境向け：row から取る（rowが1始まりなので -1 補正）
                        let rec = args.record || null;
                        if (!rec && grid.records && typeof args.row === 'number') {
                            const idx = Math.max(0, args.row - 1);
                            rec = grid.records[idx] || null;
                        }

                        const id = rec && rec.id ? rec.id : null;
                        if (!id) return;

                        openManifestationPopup(id);
                    });

                    // ホバーで「ボタン」感（カーソル）
                    grid.listen('mousemove_cell', function(args) {
                        if (!args) return;
                        parentElement.style.cursor = (args.col === 0) ? 'pointer' : '';
                    });
                    grid.listen('mouseleave_grid', function() {
                        parentElement.style.cursor = '';
                    });

                }

                // 表示切替
                document.querySelectorAll('.btn-view-mode').forEach(button => {
                    button.addEventListener('click', function() {
                        const newMode = this.getAttribute('data-mode');

                        let vm = searchForm.querySelector('input[name="view_mode"]');
                        if (!vm) {
                            vm = document.createElement('input');
                            vm.type = 'hidden';
                            vm.name = 'view_mode';
                            searchForm.appendChild(vm);
                        }
                        vm.value = newMode;
                        searchForm.submit();
                    });
                });

                // エクスポート
                const exportBtnEl = document.getElementById('btn-export');
                if (exportBtnEl) {
                    exportBtnEl.addEventListener('click', function() {
                        const formData = new FormData(searchForm);
                        const queryParams = new URLSearchParams(formData);
                        queryParams.delete('view_mode');
                        window.location.href = '{{ path('app_manifestation_file_export') }}?' + queryParams.toString();
                    });
                }

                // 検索（AJAX）
                searchForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const formData = new FormData(searchForm);
                    const viewMode = (searchForm.querySelector('input[name="view_mode"]')?.value) || '{{ view_mode|default("list") }}';
                    formData.set('view_mode', viewMode);
                    const queryParams = new URLSearchParams(formData);

                    loading.classList.remove('d-none');

                    fetch('{{ path('app_manifestation_search') }}?' + queryParams.toString(), {
                        method: 'GET',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                        .then(response => (viewMode === 'grid' ? response.json() : response.text()))
                        .then(data => {
                            loading.classList.add('d-none');
                            if (viewMode === 'grid') {
                                renderGrid(data);
                                return;
                            }
                            searchResults.innerHTML = data;
                            loadPanelImages();
                            initMapView();
                        });
                });

                if (sortSelect) {
                    sortSelect.addEventListener('change', function() {
                        searchForm.dispatchEvent(new Event('submit'));
                    });
                }

                loadPanelImages();
                initMapView();

                // 初期状態が grid の場合は自動実行
                if ('{{ view_mode|default("list") }}' === 'grid') {
                    searchForm.dispatchEvent(new Event('submit'));
                }
            });
        </script>
    {% endblock %}
