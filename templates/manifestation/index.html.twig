{% extends 'base.html.twig' %}

{% block title %}{{ 'Screen.Manifestation.Index'|trans }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .view-mode-buttons .btn.active { background-color: #007bff; color: white; }
        .panel-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .panel-item { width: calc(25% - 15px); text-align: center; border: 1px solid #ddd; padding: 10px; border-radius: 8px; transition: background-color 0.2s, transform 0.2s; display: block; }
        .panel-item:hover { background-color: #f8f9fa; border-color: #007bff; transform: translateY(-2px); text-decoration: none; }
        .panel-item .panel-image-container { width: 100%; height: 180px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; background-color: #f1f3f5; border-radius: 4px; overflow: hidden; }
        .panel-item img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #grid-container { width: 100%; height: 600px; border: 1px solid #ddd; }
    </style>
{% endblock %}

{% block body %}
    <div class="container mt-4">
        <!-- 検索フォーム -->
        <div class="card mt-4 mb-4">
            <div class="card-header">
                <h5>書誌検索</h5>
            </div>

            <div class="card-body">
                <form action="{{ path('app_manifestation_index') }}" method="get" id="search_form">
                    <input type="hidden" name="mode" id="search_mode" value="{{ search_params.mode|default('simple') }}">

                    <div class="mb-3">
                        {# モード1: キーワード入力 (Simple) #}
                        <div id="wrapper_q_simple" class="search-wrapper">
                            <label for="search_q_single" class="form-label small fw-bold">キーワード検索</label>
                            <input type="text" name="q" id="search_q_single" class="form-control"
                                   value="{{ search_params.q|default('') }}" placeholder="キーワードを入力...">
                        </div>

                        {# モード2: 複数識別子 (Multi) #}
                        <div id="wrapper_q_multi" class="search-wrapper d-none">
                            <label for="search_q_multi" class="form-label small fw-bold">識別子を複数検索（1行1件）</label>
                            <textarea name="q" id="search_q_multi" class="form-control"
                                      rows="5" placeholder="1行に1つの識別子を入力..." disabled>{{ search_params.q|default('') }}</textarea>
                        </div>

                        {# モード3: 詳細検索 (Advanced) #}
                        <div id="wrapper_advanced" class="search-wrapper d-none">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">識別子（前方一致）</label>
                                    <input type="text" name="identifier" class="form-control" value="{{ search_params.identifier|default('') }}" disabled>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">タイプ1（完全一致）</label>
                                    <input type="text" name="type1" class="form-control" value="{{ search_params.type1|default('') }}" disabled>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">タイプ2（完全一致）</label>
                                    <input type="text" name="type2" class="form-control" value="{{ search_params.type2|default('') }}" disabled>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button class="btn btn-outline-secondary btn-sm" type="button" id="toggle_search_mode">
                            <i class="bi bi-gear"></i> モード切替
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> {{ 'Model.actions.search'|trans|default('検索実行') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>

            <div class="view-mode-buttons d-flex justify-content-between align-items-center">
                <div>
                    <span class="me-2">表示切替:</span>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-view-mode {{ (view_mode|default('list')) == 'list' ? 'active' : '' }}" data-mode="list" title="リスト方式">
                            <i class="fas fa-list"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-view-mode {{ (view_mode|default('list')) == 'panel' ? 'active' : '' }}" data-mode="panel" title="パネル方式">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-view-mode {{ (view_mode|default('list')) == 'grid' ? 'active' : '' }}" data-mode="grid" title="グリッド形式">
                            <i class="fas fa-table"></i>
                        </button>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-secondary me-3" id="result-count">
                            検索結果: {{ manifestations|length }} 件
                    </span>
                    <button type="button" id="btn-export" class="btn btn-outline-success">
                        <i class="fas fa-file-export"></i> エクスポート
                    </button>
                </div>
            </div>

            <!-- 検索結果を表示するエリア -->
            <div id="search-results" class="mt-4">
                {% if (view_mode|default('list')) != 'grid' %}
                    {% include 'manifestation/_results_list.html.twig' %}
                {% else %}
                    <div id="grid-container" class="grid-sample" style="height: 600px;"></div>
                {% endif %}
            </div>

            <!-- ローディングインジケーター (不足していた要素を追加) -->
            <div id="loading" class="text-center d-none my-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">読み込み中...</span>
                </div>
            </div>
        </div>
    {% endblock %}

    {% block javascripts %}
        {{ parent() }}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                let grid = null;
                const searchForm = document.getElementById('search_form');
                const searchResults = document.getElementById('search-results');
                const loading = document.getElementById('loading');
                let currentViewMode = '{{ view_mode|default("list") }}';
                const modeInput = document.getElementById('search_mode');
                const toggleBtn = document.getElementById('toggle_search_mode');

                const wrappers = {
                    'simple': document.getElementById('wrapper_q_simple'),
                    'multi': document.getElementById('wrapper_q_multi'),
                    'advanced': document.getElementById('wrapper_advanced')
                };

                function switchMode(newMode) {
                    Object.keys(wrappers).forEach(m => {
                        const isTarget = (m === newMode);
                        wrappers[m].classList.toggle('d-none', !isTarget);
                        // input/textarea/selectを有効化・無効化（送信対象を制御）
                        wrappers[m].querySelectorAll('input, textarea, select').forEach(el => el.disabled = !isTarget);
                    });
                    modeInput.value = newMode;
                }

                // 初期状態の復元
                switchMode(modeInput.value);

                toggleBtn.addEventListener('click', function() {
                    const current = modeInput.value;
                    let next = 'simple';
                    if (current === 'simple') next = 'multi';
                    else if (current === 'multi') next = 'advanced';

                    switchMode(next);
                });


                // 表示切替ボタンのクリックイベント
                document.querySelectorAll('.btn-view-mode').forEach(button => {
                    button.addEventListener('click', function() {
                        const newMode = this.getAttribute('data-mode');

                        // hidden field がなければ作成、あれば更新
                        let modeInput = searchForm.querySelector('input[name="view_mode"]');
                        if (!modeInput) {
                            modeInput = document.createElement('input');
                            modeInput.type = 'hidden';
                            modeInput.name = 'view_mode';
                            searchForm.appendChild(modeInput);
                        }
                        modeInput.value = newMode;

                        // 通常のフォーム送信（ページリロード）を行うことで検索条件を維持
                        searchForm.submit();
                    });
                });

                // エクスポートボタンのクリックイベント
                const exportBtn = document.getElementById('btn-export');
                if (exportBtn) {
                    exportBtn.addEventListener('click', function() {
                        const formData = new FormData(searchForm);
                        const queryParams = new URLSearchParams(formData);
                        // view_modeはエクスポートには不要なので削除（任意）
                        queryParams.delete('view_mode');

                        // エクスポート画面のURLへ、現在の検索パラメータを付与して遷移
                        window.location.href = '{{ path('app_manifestation_file_export') }}?' + queryParams.toString();
                    });
                }

                searchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(searchForm);
                    const viewMode = '{{ view_mode|default("list") }}';
                    formData.set('view_mode', viewMode);
                    const queryParams = new URLSearchParams(formData);

                    loading.classList.remove('d-none');

                    fetch('{{ path('app_manifestation_search') }}?' + queryParams.toString(), {
                        method: 'GET',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(response => (viewMode === 'grid' ? response.json() : response.text()))
                    .then(data => {
                        loading.classList.add('d-none');
                        if (viewMode === 'grid') {
                            renderGrid(data);
                        } else {
                            searchResults.innerHTML = data;
                        }
                    });
                });

                function renderGrid(records) {
                    const parentElement = document.getElementById("grid-container");
                    if (!parentElement) return;

                    if (grid) {
                        grid.records = records;
                    } else {
                        grid = new cheetahGrid.ListGrid({
                            parentElement: parentElement,
                            header: [
                                { field: "id", caption: "ID", width: 60 },
                                { field: "title", caption: "タイトル", width: 300 },
                                { field: "identifier", caption: "識別子", width: 150 },
                                { field: "externalIdentifier1", caption: "外部ID1", width: 150 },
                                { field: "purchaseDate", caption: "購入日", width: 120 },
                            ],
                            records: records,
                            frozenColCount: 1,
                        });
                    }
                }

                // 初期状態が grid の場合は自動実行
                if ('{{ view_mode|default("list") }}' === 'grid') {
                    searchForm.dispatchEvent(new Event('submit'));
                }
            });
        </script>
    {% endblock %}
