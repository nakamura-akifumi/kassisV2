{% extends 'base.html.twig' %}

{% block title %}予約・貸出・返却{% endblock %}

{% block body %}
<div class="container py-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h1 class="h4 mb-1">予約・貸出・返却</h1>
            <p class="text-muted small mb-0">各業務の専用画面へ進んでください。</p>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h2 class="h6">予約</h2>
                    <p class="text-muted small">利用者とManifestationの識別子を読み取って登録します。</p>
                    <a class="btn btn-outline-primary w-100" href="{{ path('app_circulation_reserve_page') }}">予約画面へ</a>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h2 class="h6">貸出</h2>
                    <p class="text-muted small">複数冊の連続読取にも対応します。</p>
                    <a class="btn btn-outline-success w-100" href="{{ path('app_circulation_checkout_page') }}">貸出画面へ</a>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h2 class="h6">返却</h2>
                    <p class="text-muted small">Manifestation識別子を読み取って返却登録します。</p>
                    <a class="btn btn-outline-warning w-100" href="{{ path('app_circulation_checkin_page') }}">返却画面へ</a>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mt-4">
        <div class="card-header bg-white">
            <strong>状況一覧</strong>
        </div>
        <div class="card-body">
            <form class="row g-2 align-items-center" method="get" action="{{ path('app_circulation_index') }}">
                <div class="col-sm-6 col-md-4">
                    <label class="form-label small mb-1" for="status-type">表示区分</label>
                    <select class="form-select" id="status-type" name="type">
                        <option value="reserve" {% if type == 'reserve' %}selected{% endif %}>予約</option>
                        <option value="checkout" {% if type == 'checkout' %}selected{% endif %}>貸出</option>
                        <option value="return" {% if type == 'return' %}selected{% endif %}>返却</option>
                    </select>
                </div>
                <div class="col-auto align-self-end">
                    <button type="button" class="btn btn-outline-success" id="status-export-btn">エクスポート</button>
                </div>
            </form>
        </div>
        <div class="card-body p-0 border-top">
            {% if type == 'reserve' %}
                {% if reservations is empty %}
                    <div class="p-3 small text-muted">予約データがありません。</div>
                {% else %}
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>予約日時</th>
                                    <th>利用者</th>
                                    <th>資料</th>
                                    <th>ステータス</th>
                                    <th>予約期限</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reservation in reservations %}
                                    <tr>
                                        <td>{{ reservation.reservedAt|date('Y-m-d H:i') }}</td>
                                        <td>
                                            {{ reservation.member.fullName }}
                                            <div class="text-muted small">{{ reservation.member.identifier }}</div>
                                        </td>
                                        <td>
                                            {{ reservation.manifestation.title }}
                                            <div class="text-muted small">{{ reservation.manifestation.identifier }}</div>
                                        </td>
                                        <td>{{ reservation.status }}</td>
                                        <td>
                                            {% if reservation.expiryDate %}
                                                {{ reservation.expiryDate|date('Y-m-d H:i') }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            {% else %}
                {% if checkouts is empty %}
                    <div class="p-3 small text-muted">
                        {% if type == 'checkout' %}
                            貸出データがありません。
                        {% else %}
                            返却データがありません。
                        {% endif %}
                    </div>
                {% else %}
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    {% if type == 'checkout' %}
                                        <th>貸出日時</th>
                                        <th>利用者</th>
                                        <th>資料</th>
                                        <th>返却期限</th>
                                        <th>ステータス</th>
                                    {% else %}
                                        <th>返却日時</th>
                                        <th>利用者</th>
                                        <th>資料</th>
                                        <th>貸出日時</th>
                                        <th>ステータス</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for checkout in checkouts %}
                                    {% set statusLabel = checkout.status == 'checked_out' ? '貸出中' : (checkout.status == 'returned' ? '返却済' : checkout.status) %}
                                    <tr>
                                        {% if type == 'checkout' %}
                                            <td>{{ checkout.checkedOutAt|date('Y-m-d H:i') }}</td>
                                            <td>
                                                {{ checkout.member.fullName }}
                                                <div class="text-muted small">{{ checkout.member.identifier }}</div>
                                            </td>
                                            <td>
                                                {{ checkout.manifestation.title }}
                                                <div class="text-muted small">{{ checkout.manifestation.identifier }}</div>
                                            </td>
                                            <td>
                                                {% if checkout.dueDate %}
                                                    {{ checkout.dueDate|date('Y-m-d') }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>{{ statusLabel }}</td>
                                        {% else %}
                                            <td>
                                                {% if checkout.checkedInAt %}
                                                    {{ checkout.checkedInAt|date('Y-m-d H:i') }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ checkout.member.fullName }}
                                                <div class="text-muted small">{{ checkout.member.identifier }}</div>
                                            </td>
                                            <td>
                                                {{ checkout.manifestation.title }}
                                                <div class="text-muted small">{{ checkout.manifestation.identifier }}</div>
                                            </td>
                                            <td>{{ checkout.checkedOutAt|date('Y-m-d H:i') }}</td>
                                            <td>{{ statusLabel }}</td>
                                        {% endif %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<script>
    const typeSelect = document.getElementById('status-type');
    const exportButton = document.getElementById('status-export-btn');
    if (typeSelect) {
        typeSelect.addEventListener('change', () => {
            typeSelect.form.submit();
        });
    }
    if (typeSelect && exportButton) {
        exportButton.addEventListener('click', () => {
            const typeValue = typeSelect.value || 'reserve';
            const url = '{{ path('app_circulation_export') }}' + '?type=' + encodeURIComponent(typeValue);
            window.location.href = url;
        });
    }
</script>
{% endblock %}
